{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <div class="d-flex align-items-center justify-content-between">
        <div>
            <h1 class="m-0"><i class="fas fa-cut me-2"></i>Serviços</h1>
            <p class="text-muted m-0">Gerencie e pesquise serviços do sistema</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('servicos_inserir') }}" class="btn btn-primary">
                <i class="fas fa-plus me-1"></i>Inserir
            </a>
        </div>
    </div>
</div>

<form class="card card-body mb-3" method="get" action="{{ url_for('servicos_pesquisar') }}">
    <input type="hidden" name="search" value="1">
    <div class="row g-3 align-items-end">
        <div class="col-12 col-md-4">
            <label class="form-label">Buscar por nome</label>
            <input type="text" name="query" value="{{ query or '' }}" class="form-control" placeholder="Ex.: Corte de cabelo">
        </div>
        <div class="col-12 col-md-2">
            <label class="form-label">Somente ativos</label>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="1" id="only_active" name="only_active" {% if only_active %}checked{% endif %}>
                <label class="form-check-label" for="only_active">Ativo</label>
            </div>
        </div>
        <div class="col-6 col-md-2">
            <label class="form-label">Preço mín.</label>
            <input type="number" step="0.01" min="0" class="form-control" name="min_preco" value="{{ min_preco if min_preco is not none else '' }}">
        </div>
        <div class="col-6 col-md-2">
            <label class="form-label">Preço máx.</label>
            <input type="number" step="0.01" min="0" class="form-control" name="max_preco" value="{{ max_preco if max_preco is not none else '' }}">
        </div>
        <div class="col-6 col-md-2">
            <label class="form-label">Ordenar por</label>
            <select class="form-select" name="sort">
                <option value="nome" {% if sort=='nome' %}selected{% endif %}>Nome</option>
                <option value="preco" {% if sort=='preco' %}selected{% endif %}>Preço</option>
                <option value="duracao" {% if sort=='duracao' %}selected{% endif %}>Duração</option>
            </select>
        </div>
        <div class="col-6 col-md-2">
            <label class="form-label">Direção</label>
            <select class="form-select" name="direction">
                <option value="asc" {% if direction=='asc' %}selected{% endif %}>Asc</option>
                <option value="desc" {% if direction=='desc' %}selected{% endif %}>Desc</option>
            </select>
        </div>
        <div class="col-6 col-md-2">
            <label class="form-label">Por página</label>
            <select class="form-select" name="per_page">
                {% for n in [5,10,20,50] %}
                    <option value="{{ n }}" {% if per_page==n %}selected{% endif %}>{{ n }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-12 col-md-2">
            <button type="submit" class="btn btn-primary w-100">Aplicar</button>
        </div>
    </div>

    {% if query or only_active or min_preco is not none or max_preco is not none %}
    <div class="mt-3 d-flex flex-wrap align-items-center gap-2">
        <span class="text-muted small">Filtros ativos:</span>
        {% if query %}<span class="badge bg-light text-dark border">Nome: <strong>{{ query }}</strong></span>{% endif %}
        {% if only_active %}<span class="badge bg-success">Somente ativos</span>{% endif %}
        {% if min_preco is not none %}<span class="badge bg-light text-dark border">Preço ≥ {{ '%.2f'|format(min_preco) }}</span>{% endif %}
        {% if max_preco is not none %}<span class="badge bg-light text-dark border">Preço ≤ {{ '%.2f'|format(max_preco) }}</span>{% endif %}
    </div>
    {% endif %}
</form>

<div class="card">
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0 resizable">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th class="text-end">Preço (R$)</th>
                    <th class="text-center">Duração (min)</th>
                    <th class="text-center">Ativo</th>
                    <th class="text-end">Ações</th>
                </tr>
            </thead>
            <tbody>
                {% if show_results and servicos and servicos.items %}
                    {% for s in servicos.items %}
                        <tr>
                            <td>
                                <div class="fw-semibold">{{ s.nome }}</div>
                                {% if s.descricao %}
                                    <div class="text-muted small">{{ s.descricao }}</div>
                                {% endif %}
                            </td>
                            <td class="text-end">{{ '%.2f'|format(s.preco) }}</td>
                            <td class="text-center">{{ s.duracao_minutos }}</td>
                            <td class="text-center">
                                {% if s.ativo %}
                                    <span class="badge bg-success">Ativo</span>
                                {% else %}
                                    <span class="badge bg-secondary">Inativo</span>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-light dropdown-toggle" type="button" id="dropdownMenuButton-{{ s.id }}" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-cog"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton-{{ s.id }}">
                                        <li><a class="dropdown-item" href="{{ url_for('servicos_visualizar', servico_id=s.id) }}"><i class="fas fa-eye me-2"></i>Visualizar</a></li>
                                        <li><a class="dropdown-item" href="{{ url_for('servicos_editar', servico_id=s.id) }}"><i class="fas fa-pen-to-square me-2"></i>Editar</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <form method="post" action="{{ url_for('servicos_excluir', servico_id=s.id) }}" class="d-inline" onsubmit="return confirm('Excluir o serviço {{ s.nome }}? Esta ação não pode ser desfeita.');">
                                                <button type="submit" class="dropdown-item text-danger"><i class="fas fa-trash me-2"></i>Excluir</button>
                                            </form>
                                        </li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="5" class="text-center py-5">
                            {% if show_results %}
                                <i class="fas fa-search fa-2x text-muted mb-2"></i>
                                <div class="text-muted">Nenhum serviço encontrado com os filtros informados.</div>
                            {% else %}
                                <i class="fas fa-filter fa-2x text-muted mb-2"></i>
                                <div class="text-muted">Use os filtros acima e clique em "Aplicar" para visualizar os serviços.</div>
                            {% endif %}
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
            <div class="text-muted">Total: {{ servicos.total if servicos else 0 }} itens</div>
            <nav>
                <ul class="pagination m-0">
                    <li class="page-item {% if not (servicos and servicos.has_prev) %}disabled{% endif %}">
                        <form method="get" class="m-0">
                            <input type="hidden" name="query" value="{{ query or '' }}">
                            <input type="hidden" name="only_active" value="{% if only_active %}1{% endif %}">
                            <input type="hidden" name="min_preco" value="{{ min_preco if min_preco is not none else '' }}">
                            <input type="hidden" name="max_preco" value="{{ max_preco if max_preco is not none else '' }}">
                            <input type="hidden" name="sort" value="{{ sort }}">
                            <input type="hidden" name="direction" value="{{ direction }}">
                            <input type="hidden" name="per_page" value="{{ per_page }}">
                            <input type="hidden" name="search" value="1">
                            <input type="hidden" name="page" value="{{ servicos.prev_num if (servicos and servicos.has_prev) else 1 }}">
                            <button class="page-link" {% if not (servicos and servicos.has_prev) %}tabindex="-1" aria-disabled="true"{% endif %}>&laquo;</button>
                        </form>
                    </li>
                    <li class="page-item disabled"><span class="page-link">Página {{ servicos.page if servicos else 1 }} de {{ servicos.pages if servicos else 1 }}</span></li>
                    <li class="page-item {% if not (servicos and servicos.has_next) %}disabled{% endif %}">
                        <form method="get" class="m-0">
                            <input type="hidden" name="query" value="{{ query or '' }}">
                            <input type="hidden" name="only_active" value="{% if only_active %}1{% endif %}">
                            <input type="hidden" name="min_preco" value="{{ min_preco if min_preco is not none else '' }}">
                            <input type="hidden" name="max_preco" value="{{ max_preco if max_preco is not none else '' }}">
                            <input type="hidden" name="sort" value="{{ sort }}">
                            <input type="hidden" name="direction" value="{{ direction }}">
                            <input type="hidden" name="per_page" value="{{ per_page }}">
                            <input type="hidden" name="search" value="1">
                            <input type="hidden" name="page" value="{{ servicos.next_num if (servicos and servicos.has_next) else (servicos.page if servicos else 1) }}">
                            <button class="page-link" {% if not (servicos and servicos.has_next) %}tabindex="-1" aria-disabled="true"{% endif %}>&raquo;</button>
                        </form>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</div>


{% endblock %}